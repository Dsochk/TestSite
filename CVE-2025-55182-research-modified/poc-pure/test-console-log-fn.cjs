/**
 * Test: What happens when console.log receives Function constructor?
 *
 * The msanft PoC server action does: console.log("Received:", formData)
 * If formData contains Function constructor, does anything special happen?
 */

'use strict';

console.log('='.repeat(60));
console.log('Test: console.log with Function constructor');
console.log('='.repeat(60));
console.log('');

// Test 1: Basic console.log with Function
console.log('[1] console.log(Function):');
console.log('    Result:', Function);
console.log('');

// Test 2: Object with Function property
console.log('[2] console.log({ fn: Function }):');
console.log('    Result:', { fn: Function });
console.log('');

// Test 3: Object with .then = Function
console.log('[3] console.log({ then: Function }):');
console.log('    Result:', { then: Function });
console.log('');

// Test 4: What does util.inspect do?
const util = require('util');
console.log('[4] util.inspect({ then: Function }):');
console.log('    Result:', util.inspect({ then: Function }));
console.log('');

// Test 5: JSON.stringify
console.log('[5] JSON.stringify({ then: Function }):');
try {
  console.log('    Result:', JSON.stringify({ then: Function }));
} catch (e) {
  console.log('    Error:', e.message);
}
console.log('');

// Test 6: Does console.log await anything?
console.log('[6] Testing if console.log awaits thenables:');

const thenable = {
  then: (resolve) => {
    console.log('    THENABLE WAS AWAITED!');
    resolve('resolved value');
  }
};

console.log('    Calling console.log with thenable...');
console.log('    Thenable:', thenable);
console.log('');

// Test 7: What about toString?
console.log('[7] Testing toString/valueOf:');

const objWithToString = {
  toString: () => {
    console.log('    toString() was called!');
    return 'custom string';
  },
  valueOf: () => {
    console.log('    valueOf() was called!');
    return 42;
  }
};

console.log('    Object with custom toString:', objWithToString);
console.log('    String concat:', 'prefix ' + objWithToString);
console.log('');

// Test 8: Can we make toString = Function?
console.log('[8] Object with toString = Function:');
const fnToString = {
  toString: Function.bind(null, 'return "EVIL"')
};

try {
  console.log('    Object:', fnToString);
  console.log('    String concat:', 'prefix ' + fnToString);
} catch (e) {
  console.log('    Error:', e.message);
}
console.log('');

console.log('='.repeat(60));
console.log('ANALYSIS');
console.log('='.repeat(60));
console.log('');
console.log('console.log() does NOT:');
console.log('  - Await thenables');
console.log('  - Call functions');
console.log('  - Trigger anything that would lead to RCE');
console.log('');
console.log('BUT string operations DO call toString()...');
console.log('');
